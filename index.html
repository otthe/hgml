<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flappy Bird</title>
</head>
<body>
  <game w="360" h="650">
    <sprite name="bird" src="bird.png"></sprite>

    <bird x="128" y="360" w="96" h="64" velocity="7">
      <method name="jump" action="
        this.y -= 0.5 * hgml.G.deltaTime;
        this.velocity = -7;">
      </method>

      <method name="rotate" action="
        const ROTATION_SPEED = 5;
        const MAX_ROTATION = 30;
        this.rotation = Math.min(
          Math.max(-MAX_ROTATION, this.velocity * ROTATION_SPEED),
          MAX_ROTATION
        );">
      </method>

      <method name="render" parameters='["ctx"]' action="
        ctx.save();
        ctx.translate(this.x + this.w / 2, this.y + this.h / 2); 
        ctx.rotate((this.rotation * Math.PI) / 180); 
        ctx.drawImage(
          hgml.getSprite('bird'),
          -this.w / 2,
          -this.h / 2,
          this.w,
          this.h
        ); 
        ctx.restore(); ">
      </method>

      <method name="checkBounds" action="
      const gameHeight = hgml.getState().options.h;
      if (this.y > gameHeight - this.h) {
        this.y = gameHeight - this.h;
        this.velocity = 0; 
      }

      if (this.y < 0) {
        this.y = 0;
        this.velocity = 0;
      }">
    </method>

    </bird>

    <pipe></pipe>
  </game>
  <script type="module">
    import HGML from './hgml.js';
  
    const hgml = new HGML();
    await hgml.init()
    hgml.startGameLoop();
  
    const GRAVITY = 0.5;
    const MAX_FALL_SPEED = 10;

    hgml.listen('keyup', (event) => {
      if (event.code === 'Space') {
        const bird = hgml.getObjectByType("BIRD");
        if (bird) {
          bird.jump();
        }
      }
    });
  
    hgml.setUpdate((obj, deltaTime) => {
      if (obj.type === "BIRD") {
        obj.velocity = (obj.velocity || 0) + GRAVITY * (deltaTime / 16.67);
        obj.velocity = Math.min(obj.velocity, MAX_FALL_SPEED);
        
        obj.y += obj.velocity;
        obj.rotate();
        obj.checkBounds();
      }
    });
  
    hgml.setRender((obj, ctx) => {

      if (obj.type === "BIRD") {
        obj.render(ctx);
      }
    });
  
  </script>
</body>
</html>


